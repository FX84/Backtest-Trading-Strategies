# Python-–±—ç–∫—Ç–µ—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–π —Å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–µ–π —Å–¥–µ–ª–æ–∫

`backtest.py` ‚Äî —ç—Ç–æ –ª—ë–≥–∫–∏–π –±—ç–∫—Ç–µ—Å—Ç–µ—Ä –¥–ª—è –∞–∫—Ü–∏–π/ETF/—Ñ–æ—Ä–µ–∫—Å/–∫—Ä–∏–ø—Ç–æ –Ω–∞ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö Yahoo Finance (—á–µ—Ä–µ–∑ `yfinance`). –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç 2 —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏–∑ –∫–æ—Ä–æ–±–∫–∏, –∫–æ–º–∏—Å—Å–∏–∏/—Å–ª–∏–ø–ø–µ–¥–∂, T+1 –∏—Å–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ —Ü–µ–Ω–µ `Open`, –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ `fixed/ATR`, —Å—Ç–æ–ø-–ª–æ—Å—Å –ø–æ ATR, –æ—Ç—á—ë—Ç—ã (CSV/JSON) –∏ –≥—Ä–∞—Ñ–∏–∫–∏ (PNG).

---

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ—Ç–∏—Ä–æ–≤–æ–∫ (–∞–∫—Ü–∏–∏, ETF, —Ñ–æ—Ä–µ–∫—Å, –∫—Ä–∏–ø—Ç–æ) —á–µ—Ä–µ–∑ `yfinance`.
* –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã: `1d`, `1h`, `30m`, `15m`.
* –ü–æ—Ä—Ç—Ñ–µ–ª—å –∏–∑ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–∏–∫–µ—Ä–æ–≤ —Å –≤–µ—Å–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–≤–Ω—ã–µ).
* –°—Ç—Ä–∞—Ç–µ–≥–∏–∏:

  * **SMA Cross**: –≤—Ö–æ–¥, –∫–æ–≥–¥–∞ `SMA(fast) > SMA(slow)`.
  * **RSI Revert**: –≤—Ö–æ–¥ –ø—Ä–∏ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏ (`RSI < buy`), –≤—ã—Ö–æ–¥ –ø—Ä–∏ `RSI > exit`.
* –ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∏–≥–Ω–∞–ª–æ–≤: **–Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–µ** –ø–æ —Ü–µ–Ω–µ `Open` (T+1).
* –ò–∑–¥–µ—Ä–∂–∫–∏: –∫–æ–º–∏—Å—Å–∏—è –∏ —Å–ª–∏–ø–ø–µ–¥–∂.
* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –∫–∞–ø–∏—Ç–∞–ª–∞ –∏–ª–∏ —Ä–∏—Å–∫-–º–µ–Ω–µ–¥–∂–º–µ–Ω—Ç –ø–æ ATR.
* –†–∏—Å–∫-–∫–æ–Ω—Ç—Ä–æ–ª—å: —Å—Ç–æ–ø-–ª–æ—Å—Å –ø–æ `k * ATR`, —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö.
* –ú–µ—Ç—Ä–∏–∫–∏: Total Return, CAGR, Volatility, Sharpe, Max Drawdown, Calmar, Win rate, Profit Factor –∏ –¥—Ä.
* –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã: `equity_curve.csv`, `trades.csv`, `metrics.json`, `plot_equity.png`, `plot_price_signals.png`.

---

## üß© –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* Python 3.9+
* –ü–∞–∫–µ—Ç—ã: `pandas`, `numpy`, `matplotlib`, `yfinance`

–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:

```bash
pip install -U pandas numpy matplotlib yfinance
```

---

## üì¶ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

–°–∫–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å:

```bash
git clone https://github.com/FX84/Backtest-Trading-Strategies.git
cd Backtest-Trading-Strategies
python backtest.py
```

–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:

* –¢–∏–∫–µ—Ä: `AAPL`
* –ò—Å—Ç–æ—Ä–∏—è: –ø–æ—Å–ª–µ–¥–Ω–∏–µ \~5 –ª–µ—Ç
* –ò–Ω—Ç–µ—Ä–≤–∞–ª: `1d`
* –°—Ç—Ä–∞—Ç–µ–≥–∏—è: `sma_cross` (`fast=10`, `slow=30`)
* –ö–∞–ø–∏—Ç–∞–ª: `10_000`
* –ò–∑–¥–µ—Ä–∂–∫–∏: `0`
* –û—Ç—á—ë—Ç—ã –≤ –ø–∞–ø–∫—É: `./backtest_out`

---

## üîß –ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥

### 1) SMA-cross –Ω–∞ –¥–Ω–µ–≤–∫–∞—Ö (–∞–∫—Ü–∏–∏)

```bash
python backtest.py --ticker AAPL --start 2018-01-01 \
  --strategy sma_cross --fast 10 --slow 30 \
  --fee_perc 0.001 --slippage_perc 0.0005
```

### 2) RSI-mean-reversion –Ω–∞ —á–∞—Å–æ–≤–∫–∞—Ö (—Ñ–æ—Ä–µ–∫—Å)

```bash
python backtest.py --ticker EURUSD=X --start 2022-01-01 --interval 1h \
  --strategy rsi_revert --rsi_period 14 --rsi_buy 30 --rsi_exit 50
```

### 3) –ü–æ—Ä—Ç—Ñ–µ–ª—å AAPL+MSFT —Ä–∞–≤–Ω—ã–º–∏ –¥–æ–ª—è–º–∏, —Å—Ç–æ–ø 3√óATR

```bash
python backtest.py --ticker AAPL,MSFT --start 2019-01-01 \
  --strategy sma_cross --fast 20 --slow 100 \
  --stop_atr_k 3 --fee_perc 0.001
```

### 4) –ö–∞—Å—Ç–æ–º–Ω—ã–µ –≤–µ—Å–∞ –ø–æ—Ä—Ç—Ñ–µ–ª—è + –æ—Ç—á—ë—Ç—ã –≤ —Å–≤–æ—é –ø–∞–ø–∫—É

```bash
python backtest.py --ticker AAPL,MSFT --weights AAPL=0.6,MSFT=0.4 \
  --start 2020-01-01 --out ./reports/my_test
```

---

## üßÆ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã CLI

**–î–∞–Ω–Ω—ã–µ**

* `--ticker` ‚Äî —Ç–∏–∫–µ—Ä(—ã), —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä. `AAPL,MSFT` –∏–ª–∏ `EURUSD=X`).
* `--start`, `--end` ‚Äî –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ `YYYY-MM-DD`. –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ ‚Äî \~5 –ª–µ—Ç.
* `--interval` ‚Äî `1d | 1h | 30m | 15m`.

**–°—Ç—Ä–∞—Ç–µ–≥–∏—è**

* `--strategy` ‚Äî `sma_cross | rsi_revert`
* `--fast`, `--slow` ‚Äî –ø–µ—Ä–∏–æ–¥—ã SMA –¥–ª—è `sma_cross`.
* `--rsi_period`, `--rsi_buy`, `--rsi_exit` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã RSI –¥–ª—è `rsi_revert`.

**–ò—Å–ø–æ–ª–Ω–µ–Ω–∏–µ/—Ä–∏—Å–∫**

* `--initial_capital` ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∫–∞–ø–∏—Ç–∞–ª.
* `--position` ‚Äî `fixed | atr`.
* `--risk_pct` ‚Äî % –∫–∞–ø–∏—Ç–∞–ª–∞ –Ω–∞ —Ç–∏–∫–µ—Ä (—Ä–µ–∂–∏–º `fixed`).
* `--risk_budget` ‚Äî —Ä–∏—Å–∫-–±—é–¥–∂–µ—Ç –Ω–∞ —Ç–∏–∫–µ—Ä (—Ä–µ–∂–∏–º `atr`).
* `--atr_period`, `--atr_k` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ATR –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
* `--stop_atr_k` ‚Äî —Å—Ç–æ–ø-–ª–æ—Å—Å –∫–∞–∫ `entry - k*ATR`.
* `--take_profit_perc` ‚Äî —Ç–µ–π–∫-–ø—Ä–æ—Ñ–∏—Ç, –¥–æ–ª—è (–Ω–∞–ø—Ä. `0.1 = 10%`).
* `--allow_leverage` ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π –∫—ç—à (–ø–ª–µ—á–æ).

**–ò–∑–¥–µ—Ä–∂–∫–∏**

* `--fee_perc` ‚Äî –∫–æ–º–∏—Å—Å–∏—è (–¥–æ–ª—è) –Ω–∞ –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥.
* `--slippage_perc` ‚Äî —Å–ª–∏–ø–ø–µ–¥–∂ (—É—Ö—É–¥—à–µ–Ω–∏–µ —Ü–µ–Ω—ã).

**–ü–æ—Ä—Ç—Ñ–µ–ª—å**

* `--weights` ‚Äî –≤–µ—Å–∞, –Ω–∞–ø—Ä. `AAPL=0.6,MSFT=0.4` (–Ω–æ—Ä–º–∞–ª–∏–∑—É—é—Ç—Å—è –¥–æ 1).

**–û—Ç—á—ë—Ç—ã/–¥—Ä—É–≥–æ–µ**

* `--out` ‚Äî –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `./backtest_out`).
* `--rf` ‚Äî –±–µ–∑—Ä–∏—Å–∫–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞ –¥–ª—è Sharpe (–≤ –¥–æ–ª—è—Ö, –Ω–∞–ø—Ä. `0.02`).
* `--loglevel` ‚Äî `DEBUG | INFO | WARNING | ERROR`.

---

## üìÅ –í—ã—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã

–í –∫–∞—Ç–∞–ª–æ–≥–µ `--out` –ø–æ—è–≤—è—Ç—Å—è:

* `equity_curve.csv` ‚Äî –∫—Ä–∏–≤–∞—è –∫–∞–ø–∏—Ç–∞–ª–∞ –∏ –∫—ç—à –ø–æ –¥–∞—Ç–∞–º.
* `trades.csv` ‚Äî –∂—É—Ä–Ω–∞–ª —Å–¥–µ–ª–æ–∫: –≤—Ö–æ–¥/–≤—ã—Ö–æ–¥, —Ü–µ–Ω–∞, —Ä–∞–∑–º–µ—Ä, –∫–æ–º–∏—Å—Å–∏–∏, PnL, –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å —Å–¥–µ–ª–∫–∏.
* `metrics.json` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—É—Å–∫–∞.
* `plot_equity.png` ‚Äî –≥—Ä–∞—Ñ–∏–∫ –∫—Ä–∏–≤–æ–π –∫–∞–ø–∏—Ç–∞–ª–∞.
* `plot_price_signals.png` ‚Äî —Ü–µ–Ω–∞ + —Ç–æ—á–∫–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ (–µ—Å–ª–∏ 1 —Ç–∏–∫–µ—Ä).

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏

* **Total Return**: `(Equity_end / Equity_start - 1)`.
* **CAGR**: `((Equity_end / Equity_start) ** (365 / days) - 1)`.
* **Volatility (annualized)**: `std(daily_returns) * sqrt(252)`.
* **Sharpe**: `(annual_return - rf) / annual_vol`.
* **Max Drawdown** ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ—Å–∞–¥–∫–∞ –∫—Ä–∏–≤–æ–π –∫–∞–ø–∏—Ç–∞–ª–∞.
* **Calmar**: `CAGR / |Max Drawdown|`.
* **Trades**, **Win rate**, **Avg Win / Avg Loss**, **Profit Factor**,
  **Max Consecutive Wins/Losses**, **Exposure** (–¥–æ–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤ –ø–æ–∑–∏—Ü–∏–∏).

---

## ‚öôÔ∏è –õ–æ–≥–∏–∫–∞ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è

* –°–∏–≥–Ω–∞–ª —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–≤–µ—á–µ `t` (–ø–æ –¥–∞–Ω–Ω—ã–º –¥–æ `Close[t]`).
* –°–¥–µ–ª–∫–∞ –∏—Å–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ **—Å–ª–µ–¥—É—é—â–µ–π —Å–≤–µ—á–µ** (`t+1`) –ø–æ —Ü–µ–Ω–µ `Open[t+1]` —Å —É—á—ë—Ç–æ–º —Å–ª–∏–ø–ø–µ–¥–∂–∞.
* –ö–æ–º–∏—Å—Å–∏—è —Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ –≤—Ö–æ–¥–µ –∏ –≤—ã—Ö–æ–¥–µ.
* –ü–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:

  * `fixed`: % –∫–∞–ø–∏—Ç–∞–ª–∞ \* –≤–µ—Å —Ç–∏–∫–µ—Ä–∞.
  * `atr`: `qty ‚âà risk_budget * weight / (atr_k * ATR)`.
* –°—Ç–æ–ø/—Ç–µ–π–∫:

  * –°—Ç–æ–ø: `entry - stop_atr_k * ATR_entry`.
  * –¢–µ–π–∫: `entry * (1 + take_profit_perc)`.
  * –ü—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —Å—Ç–æ–ø–∞.

---

## üß± –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è

* –î–∞–Ω–Ω—ã–µ Yahoo Finance –º–æ–≥—É—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø—Ä–æ–ø—É—Å–∫–∏/–∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∏; –¥–ª—è –≤–Ω—É—Ç—Ä–∏–¥–Ω–µ–≤–Ω—ã—Ö –±–∞—Ä–æ–≤ –∏—Å—Ç–æ—Ä–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞.
* –ú–æ–¥–µ–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —É–ø—Ä–æ—â–µ–Ω–æ (–Ω–µ—Ç –∫–æ–º–∏—Å—Å–∏–π –∑–∞ –ø–µ—Ä–µ–Ω–æ—Å, –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –Ω–∞ –∫—ç—à, –ø—Ä–æ—Å–∫–∞–ª—å–∑—ã–≤–∞–Ω–∏–µ ‚Äî –ª–∏–Ω–µ–π–Ω–æ–µ).
* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ç–∫—Ç–µ—Å—Ç–æ–≤ **–Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É—é—Ç** –±—É–¥—É—â—É—é –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å.

**–î–∏—Å–∫–ª–µ–π–º–µ—Ä:** –ú–∞—Ç–µ—Ä–∏–∞–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω—ã—Ö —Ü–µ–ª—è—Ö –∏ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–µ–π.

---

## üóÇ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
Backtest-Trading-Strategies/
‚îú‚îÄ backtest.py          # –æ—Å–Ω–æ–≤–Ω–æ–π –∏ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–æ–¥
‚îú‚îÄ backtest_out/        # –ø–∞–ø–∫–∞ —Å –æ—Ç—á—ë—Ç–∞–º–∏ (—Å–æ–∑–¥–∞—ë—Ç—Å—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ)
‚îî‚îÄ README.md
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

* –í–∫–ª—é—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏:

  ```bash
  python backtest.py --loglevel DEBUG ...
  ```
* –ï—Å–ª–∏ `trades.csv` –ø—É—Å—Ç–æ–π ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏, –ø–µ—Ä–∏–æ–¥ –∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª.
* –ï—Å–ª–∏ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø—Ä–æ–≤–µ—Ä—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å —Ç–∏–∫–µ—Ä–∞ –∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º.
